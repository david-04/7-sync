//----------------------------------------------------------------------------------------------------------------------
// Base class for all output streams
//----------------------------------------------------------------------------------------------------------------------

abstract class OutputStream {

    private static readonly JSON_STRINGIFY_INDENT = 4;

    //------------------------------------------------------------------------------------------------------------------
    // Stringify a piece of data
    //------------------------------------------------------------------------------------------------------------------

    private static stringify(item: unknown) {
        return "object" === typeof item
            ? JSON.stringify(item, undefined, OutputStream.JSON_STRINGIFY_INDENT)
            : `${item}`;
    }

    //------------------------------------------------------------------------------------------------------------------
    // Log messages and/or objects without indenting line breaks
    //------------------------------------------------------------------------------------------------------------------

    public log(...data: (string | object)[]) {
        this.write(data.map(OutputStream.stringify).join(" "));
    }

    //------------------------------------------------------------------------------------------------------------------
    // Log messages and/or objects with indentation after each line break
    //------------------------------------------------------------------------------------------------------------------

    public logAligned(padding: string, ...data: (string | object)[]) {
        this.write(data.map(OutputStream.stringify).join(" ").split(/\r?\n/).join(padding));
    }

    //------------------------------------------------------------------------------------------------------------------
    // Write stringified data
    //------------------------------------------------------------------------------------------------------------------

    protected write(_data: string) {
        // to override
    }

    //------------------------------------------------------------------------------------------------------------------
    // Close the stream
    //------------------------------------------------------------------------------------------------------------------

    public close() {
        // to override
    }
}

//----------------------------------------------------------------------------------------------------------------------
// A muted output stream
//----------------------------------------------------------------------------------------------------------------------

class NullOutputStream extends OutputStream { }

//----------------------------------------------------------------------------------------------------------------------
// A console output stream (stdout)
//----------------------------------------------------------------------------------------------------------------------

class ConsoleOutputStream extends OutputStream {

    //------------------------------------------------------------------------------------------------------------------
    // Write stringified data
    //------------------------------------------------------------------------------------------------------------------

    protected write(line: string) {
        console.log(line);
    }
}

//----------------------------------------------------------------------------------------------------------------------
// A file output stream
//----------------------------------------------------------------------------------------------------------------------

class FileOutputStream extends OutputStream {

    private readonly fileDescriptor;

    //------------------------------------------------------------------------------------------------------------------
    // Initialization
    //------------------------------------------------------------------------------------------------------------------

    public constructor(private readonly file: string, append: boolean) {
        super();
        try {
            this.fileDescriptor = node.fs.openSync(file, append ? "a" : "w");
        } catch (exception) {
            throw new FriendlyException(`Failed to open log file ${file}: ${exception}`);
        }
    }

    //------------------------------------------------------------------------------------------------------------------
    // Append a message to the log file
    //------------------------------------------------------------------------------------------------------------------

    protected write(line: string) {
        try {
            node.fs.writeSync(this.fileDescriptor, `${line}\n`);
        } catch (exception) {
            throw new FriendlyException(`Failed to write to log file ${this.file}: ${firstLineOnly(exception)}`);
        }
    }

    //------------------------------------------------------------------------------------------------------------------
    // Close the log file
    //------------------------------------------------------------------------------------------------------------------

    public close() {
        node.fs.closeSync(this.fileDescriptor);
    }
}
